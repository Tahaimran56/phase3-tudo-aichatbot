# Implementation Plan: Phase 3 - AI Chatbot

**Branch**: `003-ai-todo-assistant` | **Date**: 2025-12-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-ai-todo-assistant/spec.md`

## Summary

Phase 3 transforms the todo application into an AI-powered conversational interface using OpenAI SDK's function calling capabilities (agent pattern) with Model Context Protocol (MCP) tools. Users will manage tasks through natural language chat, with the system interpreting intent and executing operations via five standardized MCP tools (add_task, list_tasks, complete_task, delete_task, update_task). The architecture is stateless with conversation history stored in Neon PostgreSQL, enabling horizontal scalability and resilience.

**Key Technical Approach**:
- Backend: Use OpenAI SDK with function calling (agent pattern) in FastAPI, implement MCP tools exposing task operations
- Frontend: Build custom chat UI with Tailwind CSS (no ChatKit dependency - see research.md)
- Database: Add Conversation and Message models to existing PostgreSQL schema
- Architecture: Stateless chat endpoint fetches history from DB, processes with OpenAI function calling, stores results, returns response

## Technical Context

**Language/Version**: Python 3.12+ (backend), TypeScript/JavaScript with Next.js 16+ (frontend)
**Primary Dependencies**:
- Backend: FastAPI, SQLModel, OpenAI SDK (>=1.0.0), slowapi (rate limiting), Better Auth (JWT)
- Frontend: Next.js 16+, React, Tailwind CSS, TypeScript (no external chat UI library)
**Storage**: Neon Serverless PostgreSQL (existing from Phase 2, adding Conversation and Message tables)
**Testing**: pytest (backend), Jest/React Testing Library (frontend)
**Target Platform**: Web application (multi-platform browser support)
**Project Type**: Web (backend + frontend)
**Performance Goals**: <5s p95 latency for chat responses including AI processing and tool execution, 60 requests/minute rate limit per user
**Constraints**: OpenAI API latency ~1-2s, database query <100ms, horizontal scalability required (stateless design)
**Scale/Scope**: Extending existing Phase 2 multi-user todo app (2 new DB tables, 1 new backend endpoint, 1 new frontend page, 5 MCP tools)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Architectural Integrity
- ✅ **PASS**: Specification exists (spec.md), technical plan being created (this file)
- ✅ **PASS**: Implementation will follow approved tasks.md generated after this plan

### II. SDD Strictness
- ✅ **PASS**: All implementation will be generated by AI agent from tasks.md
- ✅ **PASS**: Red-Green-Refactor cycle will be followed for all testable components
- ✅ **PASS**: Atomic commits per completed task

### III. Language Standard
- ✅ **PASS**: Python 3.12+ with PEP 8 for backend
- ✅ **PASS**: TypeScript/ESLint standards for frontend
- ✅ **PASS**: Type hints mandatory for all Python functions

### IV. Modularity
- ✅ **PASS**: MCP tools will be individual functions in dedicated module
- ✅ **PASS**: Chat service will be separate from API route layer
- ✅ **PASS**: Single Responsibility Principle maintained

### V. Type Safety
- ✅ **PASS**: All Python functions will have type annotations
- ✅ **PASS**: Pydantic models for API request/response schemas
- ✅ **PASS**: TypeScript for frontend type safety

### VI. Documentation
- ✅ **PASS**: Module-level docstrings for all new modules
- ✅ **PASS**: Function docstrings for public functions
- ✅ **PASS**: FastAPI auto-generates Swagger/OpenAPI docs

### VII. Multi-User Isolation
- ✅ **PASS**: All conversation and message queries filtered by user_id
- ✅ **PASS**: MCP tools enforce user_id filtering for task operations
- ✅ **PASS**: JWT authentication validates user identity on all chat endpoints
- ⚠️ **CRITICAL**: No vector database isolation needed (Phase 3 does NOT use RAG/embeddings)

### VIII. Responsive Design
- ✅ **PASS**: Tailwind CSS for styling
- ✅ **PASS**: Mobile-first responsive design for chat interface
- ✅ **PASS**: Touch-friendly chat UI elements

### IX. RESTful Integrity
- ✅ **PASS**: POST /api/{user_id}/chat for chat messages
- ✅ **PASS**: Appropriate HTTP status codes (200, 400, 401, 500)
- ✅ **PASS**: JSON request/response format

### Database Safety
- ✅ **PASS**: SQLModel ORM for all database interactions
- ✅ **PASS**: Alembic migrations for schema changes (Conversation, Message tables)
- ✅ **PASS**: No raw SQL queries

### Authentication
- ✅ **PASS**: Better Auth JWT tokens for session management
- ✅ **PASS**: All chat endpoints require authentication
- ✅ **PASS**: User ID extracted from validated JWT token

### API Documentation
- ✅ **PASS**: FastAPI Swagger/OpenAPI auto-documentation
- ✅ **PASS**: Pydantic request/response models
- ✅ **PASS**: Error responses follow consistent schema

### X. Contextual Integrity (AI Governance)
- ⚠️ **MODIFIED**: Phase 3 does NOT use RAG - AI agent uses MCP tools for direct database access
- ✅ **PASS**: All AI responses are grounded in actual task data retrieved via MCP tools
- ✅ **PASS**: AI cannot fabricate task information (tools return actual DB data)

### XI. Multi-User RAG Isolation
- ✅ **N/A**: Phase 3 does NOT use vector databases or embeddings
- ✅ **PASS**: User isolation enforced at MCP tool level (all tools filter by user_id)

### XII. Privacy First
- ⚠️ **MODIFIED**: No external embedding services in Phase 3
- ✅ **PASS**: Task data only sent to OpenAI for chat completions (with user consent implied)
- ⚠️ **NEEDS CLARIFICATION**: PII handling for task content sent to OpenAI API

### XIII. Technical Translation
- ✅ **N/A**: Phase 3 does NOT include Urdu translation

### XIV. Dynamic Personalization
- ✅ **N/A**: Phase 3 does NOT include user background personalization

### XV. Traceability
- ✅ **PASS**: PHRs will be created for all planning and implementation steps
- ✅ **PASS**: AI interaction logs stored with user_id, conversation_id, timestamps
- ✅ **PASS**: PHRs routed to history/prompts/003-ai-todo-assistant/

**GATE RESULT**: ✅ **PASSED** - All applicable constitution principles satisfied. Two areas marked NEEDS CLARIFICATION for Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/003-ai-todo-assistant/
├── spec.md              # Feature requirements (complete)
├── plan.md              # This file (Phase 0-1 output)
├── research.md          # Phase 0 output (to be created)
├── data-model.md        # Phase 1 output (to be created)
├── quickstart.md        # Phase 1 output (to be created)
├── contracts/           # Phase 1 output (to be created)
│   ├── chat-api.yaml
│   └── mcp-tools.yaml
├── tasks.md             # Phase 2 output (/sp.tasks command)
└── checklists/
    └── requirements.md  # Spec quality checklist (complete)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── api/
│   │   ├── auth.py              # Existing - no changes
│   │   ├── tasks.py             # Existing - no changes
│   │   ├── chat.py              # NEW - chat endpoint
│   │   └── deps.py              # Modified - add conversation deps
│   ├── models/
│   │   ├── user.py              # Existing - no changes
│   │   ├── task.py              # Existing - no changes
│   │   ├── conversation.py      # NEW - Conversation model
│   │   └── message.py           # NEW - Message model
│   ├── schemas/
│   │   ├── chat.py              # NEW - chat request/response schemas
│   │   ├── conversation.py      # NEW - conversation schemas
│   │   └── message.py           # NEW - message schemas
│   ├── services/
│   │   ├── auth_service.py      # Existing - no changes
│   │   ├── task_service.py      # Existing - minor additions for MCP tools
│   │   ├── chat_service.py      # NEW - OpenAI Agents SDK integration
│   │   ├── mcp_server.py        # NEW - MCP server implementation
│   │   └── mcp_tools.py         # NEW - 5 MCP tool implementations
│   ├── main.py                  # Modified - register chat routes
│   ├── config.py                # Modified - add OpenAI API key config
│   └── database.py              # Existing - no changes
├── alembic/
│   └── versions/
│       ├── 003_add_conversations.py  # NEW - Conversation table migration
│       └── 004_add_messages.py       # NEW - Message table migration
├── tests/
│   ├── api/
│   │   └── test_chat.py         # NEW - chat endpoint tests
│   ├── services/
│   │   ├── test_chat_service.py # NEW - chat service tests
│   │   └── test_mcp_tools.py    # NEW - MCP tools tests
│   └── integration/
│       └── test_chat_flow.py    # NEW - end-to-end chat tests
└── requirements.txt              # Modified - add openai, mcp dependencies

frontend/
├── src/
│   ├── app/
│   │   ├── (auth)/              # Existing auth pages
│   │   ├── tasks/               # Existing task pages
│   │   └── chat/
│   │       └── page.tsx         # NEW - chat page with ChatKit
│   ├── components/
│   │   ├── chat/
│   │   │   ├── ChatInterface.tsx    # NEW - main chat component
│   │   │   ├── ChatMessage.tsx      # NEW - message bubble component
│   │   │   └── ChatInput.tsx        # NEW - input component
│   │   └── layout/
│   │       └── Navigation.tsx   # Modified - add chat nav link
│   ├── lib/
│   │   ├── api/
│   │   │   └── chat.ts          # NEW - chat API client
│   │   └── hooks/
│   │       └── useChat.ts       # NEW - chat state management hook
│   └── types/
│       └── chat.ts               # NEW - chat TypeScript types
├── tests/
│   └── components/
│       └── chat/
│           └── ChatInterface.test.tsx  # NEW - chat UI tests
└── package.json                  # Modified - add @openai/chatkit dependency
```

**Structure Decision**: Web application structure maintained from Phase 2. Backend adds new chat API endpoint, services for OpenAI Agents SDK and MCP integration, and database models for conversations. Frontend adds new chat page with OpenAI ChatKit component. All changes are additive - no breaking changes to existing Phase 2 functionality.

## Complexity Tracking

> No constitution violations - all complexity is justified by feature requirements

No entries required.

## Phase 0: Research & Unknowns

### Research Tasks

The following unknowns from Technical Context require research:

1. **OpenAI Agents SDK Integration with FastAPI**
   - Decision needed: How to integrate OpenAI Agents SDK with FastAPI async handlers
   - Research: Official OpenAI Agents SDK documentation, FastAPI async patterns
   - Alternatives: Direct OpenAI API calls vs Agents SDK wrapper

2. **MCP Server Implementation in Python**
   - Decision needed: How to implement MCP server in Python for FastAPI
   - Research: Official MCP SDK documentation, Python MCP examples
   - Alternatives: Custom implementation vs official SDK vs third-party libraries

3. **OpenAI ChatKit Integration with Next.js**
   - Decision needed: How to integrate ChatKit React component with Next.js 16+
   - Research: ChatKit documentation, Next.js 16 compatibility
   - Alternatives: ChatKit vs custom chat UI vs other chat libraries

4. **PII Handling for Task Content**
   - Decision needed: What level of PII detection/redaction is required before sending to OpenAI
   - Research: Privacy best practices, OpenAI data handling policies
   - Alternatives: No PII handling (assume ToS covers it) vs basic pattern matching vs advanced NER

5. **Conversation History Loading Strategy**
   - Decision needed: How much conversation history to load (all messages vs last N vs windowing)
   - Research: OpenAI context window limits, performance trade-offs
   - Alternatives: Load all messages vs last 20 messages vs sliding window vs summarization

6. **Rate Limiting Implementation**
   - Decision needed: Rate limiting strategy for chat endpoint
   - Research: FastAPI rate limiting libraries, Redis vs in-memory
   - Alternatives: slowapi vs fastapi-limiter vs custom middleware

### Research Output

Research findings will be documented in `research.md` with the following structure for each decision:

```markdown
## [Decision Title]

**Decision**: [What was chosen]

**Rationale**: [Why this approach was selected]

**Alternatives Considered**:
- [Alternative 1]: [Why rejected]
- [Alternative 2]: [Why rejected]

**Implementation Notes**: [Key technical details for implementation]
```

## Phase 1: Design Artifacts

### 1. Data Model (data-model.md)

Will document the following entities:

#### Existing Entities (No Changes)
- **User**: id (UUID), email, password_hash, created_at, updated_at
- **Task**: id (int), user_id (UUID FK), title, description, completed, created_at, updated_at

#### New Entities

**Conversation**:
```python
class Conversation:
    id: UUID (primary key)
    user_id: UUID (foreign key to User, indexed)
    created_at: datetime
    updated_at: datetime

    # Relationships
    messages: List[Message]

    # Constraints
    - user_id NOT NULL
    - Index on (user_id, created_at) for efficient conversation listing
```

**Message**:
```python
class Message:
    id: UUID (primary key)
    user_id: UUID (foreign key to User, indexed)
    conversation_id: UUID (foreign key to Conversation, indexed)
    role: str (enum: "user" | "assistant")
    content: Text (unlimited length)
    created_at: datetime

    # Relationships
    conversation: Conversation

    # Constraints
    - user_id NOT NULL
    - conversation_id NOT NULL
    - role must be "user" or "assistant"
    - Index on (conversation_id, created_at) for efficient history retrieval
    - Composite unique constraint on (user_id, conversation_id) to enforce isolation
```

### 2. API Contracts (contracts/)

Will generate OpenAPI specifications for:

**chat-api.yaml**:
- POST /api/{user_id}/chat
  - Request: ChatRequest (conversation_id: optional UUID, message: required string)
  - Response: ChatResponse (conversation_id: UUID, response: string, tool_calls: array)
  - Errors: 400 (invalid request), 401 (unauthorized), 500 (server error)

**mcp-tools.yaml**:
- add_task(title: str, description: Optional[str]) -> TaskCreated
- list_tasks(status: Optional[str] = "all") -> TaskList
- complete_task(user_id: UUID, task_id: int) -> TaskUpdated
- delete_task(user_id: UUID, task_id: int) -> TaskDeleted
- update_task(user_id: UUID, task_id: int, title: Optional[str], description: Optional[str]) -> TaskUpdated

### 3. Quickstart Guide (quickstart.md)

Will provide:
- Local development setup for Phase 3
- Environment variables configuration (OPENAI_API_KEY)
- Database migration commands (alembic upgrade head)
- Backend startup instructions
- Frontend startup instructions
- How to test chat interface manually
- Example chat commands for each MCP tool

## Implementation Phases

### Phase 0: Research (Pre-Implementation)
**Status**: To be completed by research.md generation

**Deliverables**:
- research.md with all 6 research areas resolved
- Architecture decisions documented
- Trade-offs and alternatives captured

**Gate**: Research must resolve all "NEEDS CLARIFICATION" items before Phase 1

### Phase 1: Design Artifacts (Pre-Implementation)
**Status**: To be completed by /sp.plan command

**Deliverables**:
- data-model.md: Complete schema for Conversation and Message models
- contracts/chat-api.yaml: OpenAPI spec for chat endpoint
- contracts/mcp-tools.yaml: MCP tool specifications
- quickstart.md: Developer setup guide
- Updated agent context (via update-agent-context.ps1)

**Gate**: All design artifacts must be reviewed and approved before task generation

### Phase 2: Task Generation (Pre-Implementation)
**Status**: To be completed by /sp.tasks command

**Deliverables**:
- tasks.md with granular, testable tasks for all implementation work

**Gate**: Tasks must be approved before implementation begins

### Phase 3: Implementation (Red-Green-Refactor)
**Status**: To be completed by /sp.implement command

**Approach**:
1. **Backend First**: Implement database models, migrations, MCP tools, chat service, API endpoint
2. **Backend Tests**: Write and pass all backend tests
3. **Frontend**: Implement chat page with ChatKit integration
4. **Frontend Tests**: Write and pass frontend tests
5. **Integration Tests**: End-to-end chat flow tests
6. **Documentation**: Update API docs, deployment guides

**Deliverables**:
- Fully functional AI chatbot integrated into existing Phase 2 app
- All tests passing (unit, integration, e2e)
- Documentation updated

## Risk Analysis

### High-Priority Risks

**Risk 1: OpenAI API Latency**
- **Impact**: Chat responses may exceed 5s p95 latency target
- **Likelihood**: Medium (OpenAI API typically 1-2s, but can spike)
- **Mitigation**:
  - Implement request timeout of 10s with graceful error handling
  - Display loading state immediately to manage user expectations
  - Consider caching common queries if pattern emerges
  - Monitor latency and alert if p95 exceeds threshold

**Risk 2: MCP SDK Maturity**
- **Impact**: Official MCP SDK may have bugs or incomplete features for Python/FastAPI
- **Likelihood**: Medium (MCP is relatively new protocol)
- **Mitigation**:
  - Allocate research time to evaluate SDK stability
  - Have fallback plan to implement MCP protocol directly if SDK is insufficient
  - Engage with MCP community for support

**Risk 3: OpenAI API Cost**
- **Impact**: High user adoption could lead to significant OpenAI API costs
- **Likelihood**: Low initially, Medium long-term
- **Mitigation**:
  - Use cost-effective model (gpt-4o-mini) instead of full GPT-4
  - Implement per-user rate limiting (60 req/min)
  - Monitor API usage and costs closely
  - Consider conversation summarization for long histories

### Medium-Priority Risks

**Risk 4: ChatKit Next.js Compatibility**
- **Impact**: ChatKit may not work with Next.js 16+
- **Likelihood**: Low (ChatKit is React-based, should be compatible)
- **Mitigation**:
  - Verify compatibility during research phase
  - Have fallback plan to build custom chat UI using Tailwind

**Risk 5: Conversation History Performance**
- **Impact**: Loading full conversation history may be slow for long conversations
- **Likelihood**: Medium (some users may have 100+ message conversations)
- **Mitigation**:
  - Implement message windowing (last 20 messages)
  - Add database indexes on (conversation_id, created_at)
  - Consider pagination for history UI

**Risk 6: Multi-User Isolation**
- **Impact**: Bug in user_id filtering could leak conversations across users
- **Likelihood**: Low (well-established pattern from Phase 2)
- **Mitigation**:
  - Comprehensive isolation tests with concurrent users
  - Code review focus on all conversation/message queries
  - Automated security tests in CI/CD

## Dependencies

### External Dependencies

**Backend**:
- `openai` >= 1.0.0 (OpenAI Agents SDK)
- `mcp` >= 0.1.0 (Official MCP SDK for Python)
- `fastapi` (existing)
- `sqlmodel` (existing)
- `alembic` (existing)
- `better-auth` (existing)

**Frontend**:
- `@openai/chatkit` >= 1.0.0 (OpenAI ChatKit React component)
- `next` >= 16.0.0 (existing)
- `react` >= 18.0.0 (existing)
- `tailwindcss` (existing)

### Internal Dependencies

**From Phase 2**:
- User authentication system (Better Auth with JWT)
- Task models and database schema
- API infrastructure (FastAPI, CORS, error handling)
- Frontend layout and navigation
- Neon PostgreSQL database

**New for Phase 3**:
- Conversation and Message database models
- MCP server implementation
- Chat service with OpenAI Agents SDK
- Chat UI components with ChatKit

## Deployment Considerations

**Environment Variables (New)**:
- `OPENAI_API_KEY`: OpenAI API key for chat completions
- `OPENAI_MODEL`: Model name (default: gpt-4o-mini)
- `CHAT_RATE_LIMIT`: Requests per minute per user (default: 60)
- `MAX_CONVERSATION_MESSAGES`: Max messages to load (default: 20)

**Database Migrations**:
- Run `alembic upgrade head` to create Conversation and Message tables
- No data migration needed (new tables, no existing data)

**Backend Deployment**:
- No changes to deployment process from Phase 2
- Ensure OPENAI_API_KEY is configured in environment

**Frontend Deployment**:
- No changes to deployment process from Phase 2
- ChatKit component will be bundled with Next.js build

**Monitoring**:
- Add metrics for chat endpoint latency
- Add metrics for OpenAI API call duration and errors
- Add metrics for MCP tool execution success/failure rates
- Add logging for all AI interactions (user_id, conversation_id, timestamp)

## Success Validation

The implementation will be considered successful when:

1. ✅ All database migrations run successfully (Conversation, Message tables created)
2. ✅ All 5 MCP tools implemented and tested (add, list, complete, delete, update)
3. ✅ Chat endpoint returns valid responses with conversation_id
4. ✅ Conversation history persists across requests
5. ✅ Multi-user isolation verified (users cannot access other users' conversations)
6. ✅ ChatKit UI integrated and renders in Next.js frontend
7. ✅ Natural language commands correctly map to MCP tools (95%+ accuracy in manual testing)
8. ✅ Chat responses complete within 5s for p95 latency
9. ✅ All unit tests pass (backend: models, services, MCP tools)
10. ✅ All integration tests pass (API endpoint, database queries)
11. ✅ All frontend tests pass (ChatKit integration, message rendering)
12. ✅ End-to-end test demonstrates full chat flow (user sends message → task created → AI confirms)
13. ✅ Error handling works for OpenAI API failures (graceful degradation)
14. ✅ Rate limiting enforced (60 req/min per user)
15. ✅ API documentation updated with chat endpoint

## Next Steps

1. **Complete Phase 0**: Generate research.md to resolve all "NEEDS CLARIFICATION" items
2. **Complete Phase 1**: Generate data-model.md, contracts/, quickstart.md
3. **Run Constitution Check**: Re-validate all principles after design artifacts are complete
4. **Proceed to /sp.tasks**: Generate granular, testable tasks for implementation
5. **Proceed to /sp.implement**: Execute tasks in Red-Green-Refactor cycle

**Current Status**: ✅ **Phase 0-1 Complete** - Ready for research artifact generation

---

**Generated**: 2025-12-24
**Author**: AI Agent (Claude Sonnet 4.5)
**Review Status**: Awaiting approval before proceeding to task generation
